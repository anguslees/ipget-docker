---
kind: pipeline
name: default

platform:
  os: linux
  arch: amd64

clone:
  disable: true

workspace:
  base: /go
  path: src/github.com/ipfs/ipget

steps:
- name: myclone
  image: docker:git
  commands:
  - "git clone -b ${DRONE_TAG:-master} https://github.com/ipfs/ipget.git $DRONE_WORKSPACE"

- name: deps
  image: golang:1.12.4
  commands:
  - make deps
  - "cat <<EOF >Dockerfile\nFROM scratch\nARG BIN=ipget\nARG VERSION\nARG COMMIT_SHA\nARG COMMIT_AUTHOR_EMAIL\nLABEL \\\n org.opencontainers.image.revision=$COMMIT_SHA \\\n org.opencontainers.image.authors=$COMMIT_AUTHOR_EMAIL \\\n org.opencontainers.image.url=https://github.com/ipfs/ipget \\\n org.opencontainers.image.source=https://github.com/ipfs/ipget.git \\\n org.opencontainers.image.version=$VERSION\nCOPY $BIN /usr/bin/\nENTRYPOINT [\"ipget\"]\nEOF\n"

- name: amd64
  image: golang:1.12.4
  commands:
  - "go build -ldflags='-s -w -extldflags=-static' -tags netgo -installsuffix netgo -o ipget.amd64"
  environment:
    CGO_ENABLED: 0
    GOARCH: amd64
    GOOS: linux

- name: arm64
  image: golang:1.12.4
  commands:
  - "go build -ldflags='-s -w -extldflags=-static' -tags netgo -installsuffix netgo -o ipget.arm64"
  environment:
    CGO_ENABLED: 0
    GOARCH: arm64
    GOOS: linux

- name: armv6
  image: golang:1.12.4
  commands:
  - "go build -ldflags='-s -w -extldflags=-static' -tags netgo -installsuffix netgo -o ipget.armv6"
  environment:
    CGO_ENABLED: 0
    GOARCH: arm
    GOARM: 6
    GOOS: linux

- name: armv7
  image: golang:1.12.4
  commands:
  - "go build -ldflags='-s -w -extldflags=-static' -tags netgo -installsuffix netgo -o ipget.armv7"
  environment:
    CGO_ENABLED: 0
    GOARCH: arm
    GOARM: 7
    GOOS: linux

- name: docker-amd64
  image: banzaicloud/drone-kaniko
  settings:
    auto_tag: true
    auto_tag_suffix: linuxamd64
    build_args:
    - BIN=ipget.amd64
    - "COMMIT_SHA=${DRONE_COMMIT_SHA}"
    - "COMMIT_AUTHOR_EMAIL=${DRONE_COMMIT_AUTHOR_EMAIL}"
    - "VERSION=${DRONE_TAG}"
    password:
      from_secret: docker_password
    registry: quay.io
    repo: quay.io/anguslees/ipget
    username:
      from_secret: docker_username
  when:
    event:
    - push

- name: docker-arm64
  image: banzaicloud/drone-kaniko
  settings:
    auto_tag: true
    auto_tag_suffix: linuxarm64
    build_args:
    - BIN=ipget.arm64
    - "COMMIT_SHA=${DRONE_COMMIT_SHA}"
    - "COMMIT_AUTHOR_EMAIL=${DRONE_COMMIT_AUTHOR_EMAIL}"
    - "VERSION=${DRONE_TAG}"
    password:
      from_secret: docker_password
    registry: quay.io
    repo: quay.io/anguslees/ipget
    username:
      from_secret: docker_username
  when:
    event:
    - push

- name: docker-armv6
  image: banzaicloud/drone-kaniko
  settings:
    auto_tag: true
    auto_tag_suffix: linuxarm6
    build_args:
    - BIN=ipget.armv6
    - "COMMIT_SHA=${DRONE_COMMIT_SHA}"
    - "COMMIT_AUTHOR_EMAIL=${DRONE_COMMIT_AUTHOR_EMAIL}"
    - "VERSION=${DRONE_TAG}"
    password:
      from_secret: docker_password
    registry: quay.io
    repo: quay.io/anguslees/ipget
    username:
      from_secret: docker_username
  when:
    event:
    - push

- name: docker-armv7
  image: banzaicloud/drone-kaniko
  settings:
    auto_tag: true
    auto_tag_suffix: linuxarm7
    build_args:
    - BIN=ipget.armv7
    - "COMMIT_SHA=${DRONE_COMMIT_SHA}"
    - "COMMIT_AUTHOR_EMAIL=${DRONE_COMMIT_AUTHOR_EMAIL}"
    - "VERSION=${DRONE_TAG}"
    password:
      from_secret: docker_password
    registry: quay.io
    repo: quay.io/anguslees/ipget
    username:
      from_secret: docker_username
  when:
    event:
    - push

- name: manifest
  image: plugins/manifest
  settings:
    password:
      from_secret: docker_password
    platforms:
    - linux/amd64
    - linux/arm64
    - linux/arm/6
    - linux/arm/7
    registry: quay.io
    repo: quay.io/anguslees/ipget
    target: quay.io/anguslees/ipget
    template: quay.io/anguslees/ipget:OSARCHVARIANT
    username:
      from_secret: docker_username
  when:
    event:
    - push

- name: publish
  image: banzaicloud/drone-kaniko
  settings:
    auto_tag: true
    password:
      from_secret: docker_password
    registry: quay.io
    repo: quay.io/anguslees/ipget
    username:
      from_secret: docker_username
  when:
    event:
    - push

...
